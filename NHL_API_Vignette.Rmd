---
title: "Guide for Using the NHL API"
author: "Matt Kasle"
date: "9/16/2020"
output: 
  rmarkdown::github_document:
    toc: yes
    toc_float: yes
    toc_depth: 1
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(jsonlite)
library(httr)
library(tidyverse)
```

# Required Packages
This vignette requires the Tidyverse, httr, and jsonlite packages.

– You should have functions to return parsed data for each of the following endpoints from the records API (where possible, the user should have the option to specify the franchise of choice by both name and number):
∗ /franchise (Returns id, firstSeasonId and lastSeasonId and name of every team in the history of the NHL)
∗ /franchise-team-totals (Returns Total stats for every franchise (ex roadTies, roadWins, etc))
∗ /site/api/franchise-season-records?cayenneExp=franchiseId=ID (Drill-down into season records for a specific franchise)
∗ /franchise-goalie-records?cayenneExp=franchiseId=ID (Goalie records for the specified franchise)
∗ /franchise-skater-records?cayenneExp=franchiseId=ID (Skater records, same interaction as goalie endpoint)

```{r}
# Functions for Records API

tblFromAPI <- function(url, teamId = NULL){
  return(fromJSON(content(GET(url), "text"), flatten=TRUE)$data)
}

tblNHl <- function(url, team = NULL){
  if(length(team) > 0){
    if(!is.character(team)){
      return(tblFromAPI(paste0(url, "?cayenneExp=id=", team)))
    }
    else{
      teamId <- getFranchises() %>% filter(teamCommonName == team) %>% select(id)
      return(tblFromAPI(paste0(url, "?cayenneExp=id=", teamId[[1]])))
    }
  }
  return(tblFromAPI(url))
}

getFranchises <- function(team = NULL){
  return(tblNHl("https://records.nhl.com/site/api/franchise", teamId))
}

getTeamStatTotals <- function(team = NULL){
  return(tblFromAPI("https://records.nhl.com/site/api/franchise-team-totals", teamId))
}

getSingleSeasonRecords <- function(teamId){
  return(tblFromAPI(paste0("https://records.nhl.com/site/api/franchise-season-records?cayenneExp=franchiseId=",teamId)))
}

getGoalieRecords <- function(teamId){
  return(tblFromAPI(paste0("https://records.nhl.com/site/api/franchise-goalie-records?cayenneExp=franchiseId=", teamId)))
}

getSkaterRecords <- function(teamId){
  return(tblFromAPI(paste0("https://records.nhl.com/site/api/franchise-skater-records?cayenneExp=franchiseId=", teamId)))
}
```


```{r}
# Function for Stats API

getStats <- function(modifier,
                       teamIds=NULL,
                       season=NULL
                       ){
  url <- "https://statsapi.web.nhl.com/api/v1/teams"
  if(missing(modifier)){
    if(missing(teamIds)){
      return(tblFromAPI(url))
    } else{
      if (length(teamIds) == 1){
        url <- paste0(url, "/", teamIds[1]) 
        return(tblFromAPI(url))
      } else {
        url <- paste0(url, "?teamId=")
        counter = 0
        for (Id in teamIds){
          if (counter == 0){
            url <- paste0(url, Id)
        } 
          else{
            url <- paste0(url, ",", Id)
            }
          counter <- counter + 1
        }
      }
    }
    return(tblFromAPI(url))
  }
  if(modifier %in% c("team.roster", "person.names", "team.schedule.next",
                   "team.schedule.previous","team.stats", "statsSingleSeasonPlayoffs")){
    url <- paste0(url, "?expand=", modifier)
    if(length(season) > 0){
      url <- paste0(url, "&season=", season)
    }
    return(tblFromAPI(url))
  }
  else{
    return("Invalid modifier provided.")
  }
}

# ?expand=team.roster Shows roster of active players for the specified team
# ?expand=person.names Same as above, but gives less info.
# ?expand=team.schedule.next Returns details of the upcoming game for a team
# ?expand=team.schedule.previous Same as above but for the last game played
# ?expand=team.stats Returns the teams stats for the season
# ?expand=team.roster&season=20142015 Adding the season identifier shows the roster for that season
# ?teamId=4,5,29 Can string team id together to get multiple teams
# ?stats=statsSingleSeasonPlayoffs Specify which stats to get. Not fully sure all of the values

data <- getAllFranchises()
data
data %>% filter(data$id == 3)

getStats("team.roster")
```

```{r}
# wrapper function
getNHLData <- function(endpoint, teamId=NULL, season=NULL){
  if(endpoint == "franchise"){
    return(getAllFranchises())
  }
  if(endpoint == "franchise-team-totals"){
    return(getTeamStatTotals())
  }
  if(endpoint == "franchise-season-records"){
    # need to pass team Id
    return(getSingleSeasonRecords(teamId[1]))
  }
  if(endpoint == "franchise-goalie-records"){
    # need to pass team Id
    return(getGoalieRecords(teamId[1]))
  }
  if(endpoint == "franchise-skater-records"){
    # need to pass team Id
    return(getSkaterRecords(teamId[1]))
  }
  if(endpoint %in% c("team.roster", "person.names", "team.schedule.next",
                   "team.schedule.previous","team.stats", "statsSingleSeasonPlayoffs")){
    return(getStats(endpoint, teamId, season))
  }
}

```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
