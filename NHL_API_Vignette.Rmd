---
title: "Guide for Using the NHL API"
author: "Matt Kasle"
date: "9/16/2020"
output: 
  rmarkdown::github_document:
    toc: yes
    toc_float: yes
    toc_depth: 1
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(jsonlite)
library(httr)
library(tidyverse)
```

# Required Packages
This vignette requires the Tidyverse, httr, and jsonlite packages.

```{r}
# Functions for Records API

recordsAPIHelper <- function(url){
  return(fromJSON(content(GET(url), "text"), flatten=TRUE)$data)
}

statsAPIHelper <- function(url, modifier){
  if(modifier == "team.roster"){
    data <- fromJSON(content(GET(url), "text"), flatten=TRUE)$teams
    for (i in 1:nrow(data)){
      if(i == 1){
        rosterData <- data[i, "roster.roster"]
      }
      else{
        rosterData <- bind_rows(rosterData, data[i, "roster.roster"])
      }
    }
    return(rosterData)
  }
  return(fromJSON(content(GET(url), "text"), flatten=TRUE)$teams)
}

getRecordsTbl <- function(url, team = NULL){
  if(length(team) > 0){
    if(!is.character(team)){
      return(tblFromAPI(paste0(url, "?cayenneExp=franchiseId=", team)))
    }
    else{
      teamId <- getFranchises() %>% filter(teamCommonName == team) %>% select(id)
      return(tblFromAPI(paste0(url, "?cayenneExp=franchiseId=", teamId[[1]])))
    }
  }
  return(tblFromAPI(url))
}

getStatsTbl <- function(modifier = NULL, team = NULL, season = NULL){
  url <- "https://statsapi.web.nhl.com/api/v1/teams"
  if(length(team) > 0){
    if(!is.character(team)){
      url <- paste0(url, "/", team)
    }
    else{
      teamId <- getFranchises() %>% filter(teamCommonName == team) %>% select(id)
      url <- paste0(url, "/", teamId)
    }
  }
  if(length(modifier) > 0){
    url <- paste0(url, "?expand=", modifier)
    if(length(season) > 0){
      url <- paste0(url, "&season=", season)
    }
  }
  return(statsAPIHelper(url, modifier))
}

getFranchises <- function(team = NULL){
  return(getRecordsTbl("https://records.nhl.com/site/api/franchise", team))
}

getTeamStatTotals <- function(team = NULL){
  return(getRecordsTbl("https://records.nhl.com/site/api/franchise-team-totals", team))
}

getSingleSeasonRecords <- function(team = NULL){
    return(getRecordsTbl("https://records.nhl.com/site/api/franchise-season-records", team))
}

getGoalieRecords <- function(team = NULL){
  return(getRecordsTbl("https://records.nhl.com/site/api/franchise-goalie-records", team))
}

getSkaterRecords <- function(team = NULL){
  return(getRecordsTbl("https://records.nhl.com/site/api/franchise-skater-records", team))
}
```


```{r}
# wrapper function
getNHLData <- function(endpoint, team=NULL, season=NULL){
  if(endpoint == "franchises"){
    return(getFranchises(team))
  }
  if(endpoint == "franchise-team-totals"){
    return(getTeamStatTotals(team))
  }
  if(endpoint == "franchise-season-records"){
    # need to pass team Id
    return(getSingleSeasonRecords(team))
  }
  if(endpoint == "franchise-goalie-records"){
    # need to pass team Id
    return(getGoalieRecords(team))
  }
  if(endpoint == "franchise-skater-records"){
    # need to pass team Id
    return(getSkaterRecords(team))
  }
  if(endpoint %in% c("team.roster", "person.names", "team.schedule.next",
                   "team.schedule.previous","team.stats", "statsSingleSeasonPlayoffs")){
    return(getStatsTbl(modifier = endpoint, team = team, season = season))
  }
}

```
Possible endpoints:
franchises
franchise-team-totals
franchise-season-records
franchise-goalie-records
franchise-skater-records
team.roster
person.names
team.schedule.next
team.schedule.previous
team.stats
statsSingleSeasonPlayoffs



# Data Exploration

To explore the NHL API, I'm going to explore the long franchise history of the Boston Bruins, and compare them to one of their archrivals and fellow Original Six team, the Montreal Canadians.

When was the first Bruins season?
```{r, message=FALSE}
getNHLData("franchises", team="Bruins")$firstSeasonId


fromJSON(content(GET("https://statsapi.web.nhl.com/api/v1/teams/12?stats=statsSingleSeasonPlayoffs"), "text"), flatten=TRUE)$teams

statsAPIHelper("")
```
First year was 1924.

Let's look at the Bruins' win percentage every year. For this purpose, we will exclude ties. We'll also graph the average 

```{r}
franchises
franchise-team-totals
franchise-season-records
franchise-goalie-records
franchise-skater-records
team.roster
person.names
team.schedule.next
team.schedule.previous
team.stats

getNHLData("team.roster")
x$roster.roster
getNHLData("team.roster", "Bruins")

getNHLData("person.names")
getNHLData("person.names", "Bruins")

getNHLData("team.schedule.next", 6)
getNHLData("team.schedule.next", "Bruins")

getNHLData("team.schedule.previous", 6)
getNHLData("team.schedule.previous", "Bruins")

getNHLData("team.stats", 6)
getNHLData("team.stats", "Bruins")

getNHLData("team.schedule.previous", 6)
getNHLData("team.schedule.previous", "Bruins")

getNHLData("statsSingleSeasonPlayoffs", 6)
getNHLData("statsSingleSeasonPlayoffs", "Bruins")

```

