---
title: "Guide for Using the NHL API"
author: "Matt Kasle"
date: "9/16/2020"
output: 
  rmarkdown::github_document:
    toc: yes
    toc_float: yes
    toc_depth: 1
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(jsonlite)
library(httr)
library(tidyverse)
```

# Required Packages
This vignette requires the Tidyverse, httr, and jsonlite packages.

```{r}
# Functions for Records API

tblFromAPI <- function(url, teamId = NULL){
  return(fromJSON(content(GET(url), "text"), flatten=TRUE)$data)
}

tblNHl <- function(url, team = NULL){
  if(length(team) > 0){
    if(!is.character(team)){
      return(tblFromAPI(paste0(url, "?cayenneExp=id=", team)))
    }
    else{
      teamId <- getFranchises() %>% filter(teamCommonName == team) %>% select(id)
      return(tblFromAPI(paste0(url, "?cayenneExp=id=", teamId[[1]])))
    }
  }
  return(tblFromAPI(url))
}

getFranchises <- function(team = NULL){
  return(tblNHl("https://records.nhl.com/site/api/franchise", team))
}

getTeamStatTotals <- function(team = NULL){
  return(tblFromAPI("https://records.nhl.com/site/api/franchise-team-totals", team))
}

getSingleSeasonRecords <- function(team = NULL){
  if(length(team) == 0){
    return(tblFromAPI("https://records.nhl.com/site/api/franchise-season-records"))
  }
  else if (!is.character(team)){
    return(tblFromAPI(paste0("https://records.nhl.com/site/api/franchise-season-records?cayenneExp=franchiseId=",team)))
  }
  else{
    teamId <- getFranchises() %>% filter(teamCommonName == team) %>% select(id)
    return(tblFromAPI(paste0("https://records.nhl.com/site/api/franchise-season-records?cayenneExp=franchiseId=",teamId[1])))
  }
}

getGoalieRecords <- function(team = NULL){
  if(length(team) == 0){
    return(tblFromAPI("https://records.nhl.com/site/api/franchise-goalie-records"))
  }
  else if (!is.character(team)){
    return(tblFromAPI(paste0("https://records.nhl.com/site/api/franchise-goalie-records?cayenneExp=franchiseId=",team)))
  }
  else{
    teamId <- getFranchises() %>% filter(teamCommonName == team) %>% select(id)
    return(tblFromAPI(paste0("https://records.nhl.com/site/api/franchise-goalie-records?cayenneExp=franchiseId=",teamId[1])))
  }
}

getSkaterRecords <- function(team = NULL){
  if(length(team) == 0){
    return(tblFromAPI("https://records.nhl.com/site/api/franchise-skater-records"))
  }
  else if (!is.character(team)){
    return(tblFromAPI(paste0("https://records.nhl.com/site/api/franchise-skater-records?cayenneExp=franchiseId=",team)))
  }
  else{
    teamId <- getFranchises() %>% filter(teamCommonName == team) %>% select(id)
    return(tblFromAPI(paste0("https://records.nhl.com/site/api/franchise-skater-records?cayenneExp=franchiseId=",teamId[1])))
  }
}
```


```{r}
# Function for Stats API

getStats <- function(modifier,
                       teamIds=NULL,
                       season=NULL
                       ){
  url <- "https://statsapi.web.nhl.com/api/v1/teams"
  if(missing(modifier)){
    if(missing(teamIds)){
      return(tblFromAPI(url))
    } else{
      if (length(teamIds) == 1){
        url <- paste0(url, "/", teamIds[1]) 
        return(tblFromAPI(url))
      } else {
        url <- paste0(url, "?teamId=")
        counter = 0
        for (Id in teamIds){
          if (counter == 0){
            url <- paste0(url, Id)
        } 
          else{
            url <- paste0(url, ",", Id)
            }
          counter <- counter + 1
        }
      }
    }
    return(tblFromAPI(url))
  }
  if(modifier %in% c("team.roster", "person.names", "team.schedule.next",
                   "team.schedule.previous","team.stats", "statsSingleSeasonPlayoffs")){
    url <- paste0(url, "?expand=", modifier)
    if(length(season) > 0){
      url <- paste0(url, "&season=", season)
    }
    return(tblFromAPI(url))
  }
  else{
    return("Invalid modifier provided.")
  }
}
```

```{r}
# wrapper function
getNHLData <- function(endpoint, team=NULL, season=NULL){
  if(endpoint == "franchises"){
    return(getFranchises(team))
  }
  if(endpoint == "franchise-team-totals"){
    return(getTeamStatTotals(team))
  }
  if(endpoint == "franchise-season-records"){
    # need to pass team Id
    return(getSingleSeasonRecords(team))
  }
  if(endpoint == "franchise-goalie-records"){
    # need to pass team Id
    return(getGoalieRecords(team))
  }
  if(endpoint == "franchise-skater-records"){
    # need to pass team Id
    return(getSkaterRecords(team))
  }
  if(endpoint %in% c("team.roster", "person.names", "team.schedule.next",
                   "team.schedule.previous","team.stats", "statsSingleSeasonPlayoffs")){
    return(getStats(endpoint, team, season))
  }
}

```
Possible endpoints:
franchise
franchise-team-totals
franchise-season-records
franchise-goalie-records
franchise-skater-records
team.roster
person.names
team.schedule.next
team.schedule.previous
team.stats
statsSingleSeasonPlayoffs


# Data Exploration

To explore the NHL API, I'm going to explore the long franchise history of the Boston Bruins, and compare them to one of their archrivals and fellow Original Six team, the Montreal Canadians.

When was the first Bruins season?
```{r, message=FALSE}
getNHLData("franchises", team="Bruins")$firstSeasonId
```
First year was 1924.

Let's look at the Bruins' win percentage every year. For this purpose, we will exclude ties. We'll also graph the average 

```{r}
getNHLData("franchise-goalie-records",6)
```

